(function(){function t(t,e){for(var o in e)t[o]=e[o]}function e(e){this.opts={displayText:"刮   奖   区",wrapper:".scratchLottery",rootPath:"../iMag/plugins/scratch-lottery/",outFont:"normal 24px 黑体",inFont:"bold 16px 宋体",scratchCompleteThreshold:.5,onScratchComplete:null,width:300,height:40,lotteryReward:"",noRewardText:"谢 谢 参 与!"},t(this.opts,{scratchImageSrc:this.opts.rootPath+"img/pattern.png",contentBkImageSrc:this.opts.rootPath+"img/lottery_opened_bk.png"}),t(this.opts,e),this.wrapper=document.querySelector(this.opts.wrapper),this.wrapper.style.height=this.opts.height+"px",this.canvas=this._createCanvas(2),this.context=this.canvas.getContext("2d"),this.bkCanvas=this._createCanvas(1),this.bkCanvas.style.background="url("+this.opts.contentBkImageSrc+") repeat",this.bkContext=this.bkCanvas.getContext("2d"),this._init()}var o="ontouchstart"in window,n="undefined"!=typeof Storage,i=o?"touchstart":"mousedown",s=o?"touchmove":"mousemove",a=o?"touchend":"mouseup",r=o?"touchcancel":"mouseup",l=18,c="ScartchLottery";e.prototype={_createCanvas:function(t){var e=document.createElement("canvas");return e.width=this.opts.width,e.height=this.opts.height,e.style.position="absolute",e.style.top=this.opts.padding+"px",e.style.left=(this.wrapper.clientWidth-e.width)/2+"px",e.style.zIndex=t,this.wrapper.appendChild(e),e},_init:function(){if(this._scratchCompleteFired=!1,this.history=[],this._bkImage)this._renderCover(),this._resetCanvas(this.bkCanvas),this._renderContent();else{var t=this;this._bkImage=new Image,this._bkImage.onload=function(){t._renderCover(),t._renderContent(),t._bind(i,!0)},this._bkImage.src=this.opts.scratchImageSrc}},_renderCover:function(){var t=this,e=t.context.createPattern(t._bkImage,"repeat");t.context.fillStyle=e,t.context.fillRect(0,0,t.canvas.width,t.canvas.height);var o=t.opts.displayText;t.context.font=t.opts.outFont,t.context.fillStyle="gray",t.context.textBaseline="middle";var n=t.context.measureText(o);t.context.fillText(o,(t.canvas.width-n.width)/2,t.canvas.height/2)},_resetCanvas:function(t){var e=t.width,o=t.height;t.width=0,t.height=0,t.width=e,t.height=o},_renderContent:function(){var t=this.opts.lotteryReward||this.opts.noRewardText;this.bkContext.font=this.opts.inFont;var e=parseInt(this.opts.inFont.split(" ")[1]),o=this.bkContext.measureText(t),n={left:(this.bkCanvas.width-o.width)/2,top:(this.bkCanvas.height-e)/2,width:o.width,height:e};this.contentRect=n,this.bkContext.fillStyle="gray",this.bkContext.textBaseline="top",this.bkContext.fillText(t,n.left,n.top)},_bind:function(t,e){this.wrapper.addEventListener(t,this,!!e)},_unbind:function(t){this.wrapper.removeEventListener(t,this)},handleEvent:function(t){switch(t.type){case i:if(!o&&0!==t.button)return;this._start(t);break;case s:this._move(t);break;case a:case r:this._end(t);break;case"mouseout":this._mouseout(t)}},_clearMask:function(t,e){var o=l,n=l/2,i=t-o/2,s=e-n/2;this.context.clearRect(i,s,o,n)},_start:function(t){t.preventDefault(),t.stopPropagation(),this._bind(s,!0),this._bind(a,!0),this._bind(r,!0)},_move:function(t){t.stopPropagation();var e=o?t.touches[0]:t,n=this.canvas.getBoundingClientRect(),i=e.pageX-(n.left+window.pageXOffset),s=e.pageY-(n.top+window.pageYOffset);i>=0&&this.canvas.width>=i&&s>=0&&this.canvas.height>=s&&(this._clearMask(i,s),this.history.push({cx:i,cy:s}))},_end:function(t){t.stopPropagation(),this._unbind(s),this._unbind(a),this._unbind(r),o||this._unbind("mouseout"),this._checkComplete()},_mouseout:function(t){t.stopPropagation(),this._unbind(s),this._unbind(a),this._unbind(r),this._unbind("mouseout")},_checkComplete:function(){for(var t=this.context.getImageData(this.contentRect.left,this.contentRect.top,this.contentRect.width,this.contentRect.height),e=0,o=0;t.data.length>o;o++)0==t.data[o]&&e++;var n=e/t.data.length;n>this.opts.scratchCompleteThreshold&&!this._scratchCompleteFired&&(this._scratchCompleteFired=!0,this.opts.onScratchComplete&&this.opts.onScratchComplete.call(this,n))},_loadHistory:function(){var t=localStorage[c+"_"+"history"]||"[]";this.history=JSON.parse(t)||[];for(var e=0;this.history.length>e;e++){var o=this.history[e];this._clearMask(o.cx,o.cy)}},_storeHistory:function(){n&&this.history&&this.history.length&&(localStorage[c+"_"+"history"]=JSON.stringify(this.history))},playAgain:function(e){t(this.opts,e),this._init()}},"undefined"!=typeof exports?exports.scratchLottery=e:window.scratchLottery=e})();